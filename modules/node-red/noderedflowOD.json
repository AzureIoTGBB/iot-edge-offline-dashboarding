[{"id":"7dcf5639.4076e8","type":"function","z":"18d8764a.854eaa","name":"Build JSON","func":"//type checking\nvar getType = function (elem) {\n    return Object.prototype.toString.call(elem).slice(8, -1);\n};\n\nfunction appendLeadingZeroes(n,digits){\n  var s=\"\";\n  var start;\n  if(n <= 9){\n    start=1;\n  }\n  else if(n > 9 && n<= 99){\n    start=2;\n  }\n  else if(n > 99){\n    start=3;\n  }\n  \n  for (i=start;i<digits;i++)\n  {\n    s = s + \"0\";   \n  }\n  return s + n;\n}\n\nfunction formatDate(d){\nreturn  d.getFullYear() + \"-\" + \n        appendLeadingZeroes(d.getMonth() + 1,2) + \"-\" + \n        appendLeadingZeroes(d.getDate(),2) + \" \" + \n        appendLeadingZeroes(d.getHours(),2) + \":\" + \n        appendLeadingZeroes(d.getMinutes(),2) + \":\" + \n        appendLeadingZeroes(d.getSeconds(),2) + \".\" + \n        appendLeadingZeroes(d.getMilliseconds(),3);\n}\n\n//process a single data point instance\nvar processNode = function (rnode) {\nif (getType(rnode.Value) === 'Object')\n{\n    if (getType(rnode.Value.SourceTimestamp) !== 'Undefined')\n    {\n        if(isNaN(new Date(rnode.Value.SourceTimestamp).getTime()))\n             {rnode.Timestamp = new Date().toString(); }\n        else {rnode.Timestamp=rnode.Value.SourceTimestamp;}\n    }\n    \n    if (getType(rnode.Value.Body) !== 'Undefined')\n    {\n        rnode.Value=rnode.Value.Body;\n    }\n    else if (getType(rnode.Value.Value) !== 'Undefined')\n    {\n        rnode.Value=rnode.Value.Value;\n    }\n}\n\n//make sure correct display name\nif (getType(rnode.DisplayName) === 'Undefined'){\n    \n    if(getType(rnode.NodeId) === 'String')\n    {\n        var str1 = rnode.NodeId.split(\"=\");\n        if(str1.length>1){rnode.DisplayName=str1[str1.length-1];}\n            else {rnode.DisplayName=rnode.NodeId;}\n    }\n}\n\n//make sure timestamp property exists\nif (getType(rnode.Timestamp) === 'Undefined'){\n    rnode.Timestamp = new Date().toString();     \n}\n\n\nrnode.time = new Date(rnode.Timestamp).getTime()*1000000;\n\nif (getType(rnode.Value) === 'Boolean')\n{\n   if (rnode.Value === true)\n        rnode.Value = 1;\n    else\n        rnode.Value = 0;\n}\n\nvar new_payload = \n    {\n        measurement: \"DeviceData\",\n        fields: {\n            //Value: rnode.Value\n        },\n        tags:{\n            //NodeId: rnode.NodeId,\n            //DataPoint: rnode.DisplayName,\n            Source: rnode.ApplicationUri,\n            EventTime: formatDate(new Date(rnode.Timestamp))\n        },\n        timestamp: rnode.time\n    }\n;\n\n//new_payload.measurement = rnode.DisplayName;\nnew_payload.fields[rnode.DisplayName]=rnode.Value;\nreturn new_payload;\n}\n\n\n\n//main\nif (getType(msg.payload) === 'Array'){\n    for (index = 0; index < msg.payload.length; index++) { \n        msg.payload[index] = processNode(msg.payload[index]); \n    }\n} \nelse\n{\n    var newnode = processNode(msg.payload);\n    msg.payload = new Array(newnode);\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"x":570,"y":240,"wires":[["11a750ea.287e2f"]]}]